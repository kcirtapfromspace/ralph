{
  "project": "Ralph",
  "branchName": "feature/error-recovery-system",
  "description": "Robust error handling, checkpoint/resume, and graceful degradation system for Ralph to handle API rate limits, usage quotas, timeouts, and stalled executions",
  "userStories": [
    {
      "id": "US-001",
      "title": "Error classification types and module structure",
      "description": "As a developer, I need error classification types to categorize errors into actionable recovery strategies.",
      "acceptanceCriteria": [
        "Create src/error/mod.rs with module exports",
        "Create src/error/classification.rs with ErrorCategory enum (Transient, UsageLimit, Fatal, Timeout)",
        "Define TransientReason, UsageLimitReason, FatalReason, TimeoutReason sub-enums",
        "Define RecoveryHint enum (RetryNow, RetryAfter, WaitForUser, StopExecution, ResumeFromCheckpoint)",
        "Define ClassifiedError struct with category, message, recovery_hint, context",
        "Add pub mod error; to src/lib.rs",
        "Unit tests for classification types",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": "Foundation module - other recovery features depend on this"
    },
    {
      "id": "US-002",
      "title": "Error pattern detector for Claude Code errors",
      "description": "As Ralph, I need to detect and classify errors from agent output using pattern matching.",
      "acceptanceCriteria": [
        "Create src/error/detector.rs",
        "Define ErrorPattern struct with regex pattern, category, recovery_hint",
        "Define ErrorDetector with pre-configured patterns for Claude Code errors",
        "Detect rate limit patterns: '429', 'rate limit', 'too many requests'",
        "Detect usage limit patterns: 'plan limit', 'usage limit', 'quota exceeded'",
        "Detect auth errors: 'unauthorized', 'authentication failed', 'invalid token'",
        "Implement classify_error() that returns ClassifiedError from text",
        "Implement classify_exit_code() for timeout detection",
        "Unit tests for all pattern matching scenarios",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Uses case-insensitive regex matching"
    },
    {
      "id": "US-003",
      "title": "Checkpoint types and save/load functionality",
      "description": "As a user, I want execution state saved to checkpoint file so I can resume after interruptions.",
      "acceptanceCriteria": [
        "Create src/checkpoint/mod.rs with module exports",
        "Define Checkpoint struct with version, created_at, current_story, pause_reason, uncommitted_files",
        "Define StoryCheckpoint with story_id, iteration, max_iterations",
        "Define PauseReason enum (UsageLimitExceeded, RateLimited, UserRequested, Timeout, Error)",
        "Implement Serialize/Deserialize for all types",
        "Add pub mod checkpoint; to src/lib.rs",
        "Unit tests for serialization roundtrip",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Uses serde_json for persistence"
    },
    {
      "id": "US-004",
      "title": "Checkpoint manager with atomic saves",
      "description": "As a developer, I need a checkpoint manager to coordinate saving and loading execution state atomically.",
      "acceptanceCriteria": [
        "Create src/checkpoint/manager.rs",
        "Define CheckpointManager with checkpoint_path field",
        "Implement new() that creates .ralph directory if missing",
        "Implement save() that writes atomically (temp file then rename)",
        "Implement load() that reads and deserializes checkpoint",
        "Implement clear() that removes checkpoint file",
        "Implement exists() to check for checkpoint presence",
        "Implement verify() that validates checkpoint version and data",
        "Handle file not found gracefully in load()",
        "Unit tests for all operations",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": "Atomic writes prevent corruption on crash"
    },
    {
      "id": "US-005",
      "title": "Timeout configuration and wrapper",
      "description": "As Ralph, I need to timeout agent execution that exceeds time limits.",
      "acceptanceCriteria": [
        "Create src/timeout/mod.rs with module exports",
        "Define TimeoutConfig struct with agent_timeout, iteration_timeout, heartbeat_interval, missed_heartbeats_threshold",
        "Default agent_timeout: 600 seconds (10 minutes)",
        "Default iteration_timeout: 900 seconds (15 minutes)",
        "Default heartbeat_interval: 30 seconds",
        "Default missed_heartbeats_threshold: 3",
        "Implement TimeoutConfig::default() with these values",
        "Add pub mod timeout; to src/lib.rs",
        "Unit tests for config defaults",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Configurable via CLI flags"
    },
    {
      "id": "US-006",
      "title": "Heartbeat monitor for stall detection",
      "description": "As Ralph, I need to detect stalled agents via heartbeat monitoring.",
      "acceptanceCriteria": [
        "Create src/timeout/heartbeat.rs",
        "Define HeartbeatMonitor struct with config, last_heartbeat, sender/receiver channels",
        "Implement new() that initializes monitor with TimeoutConfig",
        "Implement pulse() that updates last_heartbeat timestamp",
        "Implement start_monitoring() that spawns background task",
        "Background task checks elapsed time since last heartbeat",
        "Send warning after missed_heartbeats_threshold - 1 missed beats",
        "Send stall detection after missed_heartbeats_threshold missed beats",
        "Implement stop() that terminates background task",
        "Unit tests for heartbeat detection",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": "Uses tokio::sync::watch for signaling"
    },
    {
      "id": "US-007",
      "title": "Retry strategy with exponential backoff",
      "description": "As Ralph, I need to retry transient errors with exponential backoff.",
      "acceptanceCriteria": [
        "Create src/pause/mod.rs with module exports",
        "Define RetryStrategy struct with base_delay, max_delay, max_attempts, jitter_percent",
        "Implement calculate_delay() with exponential backoff formula",
        "Default base_delay: 1 second, max_delay: 60 seconds, jitter: 10%",
        "Implement should_retry() based on attempt count and error category",
        "Only retry Transient category errors",
        "Add pub mod pause; to src/lib.rs",
        "Unit tests for delay calculation and retry logic",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": "Jitter prevents thundering herd"
    },
    {
      "id": "US-008",
      "title": "Pause controller for pause/resume state",
      "description": "As a user, I want to manually pause execution and resume later.",
      "acceptanceCriteria": [
        "Add PauseController struct to src/pause/mod.rs",
        "Define PauseState enum (Running, PauseRequested, Paused)",
        "Implement request_pause() that sets PauseRequested state",
        "Implement is_pause_requested() to check for pending pause",
        "Implement execute_pause() that transitions to Paused",
        "Implement resume() that transitions back to Running",
        "Use Arc<RwLock<PauseState>> for thread-safe access",
        "Unit tests for state transitions",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": "Pause happens between iterations, not mid-execution"
    },
    {
      "id": "US-009",
      "title": "Notification types and renderer",
      "description": "As a user, I want clear notifications about errors and recovery actions.",
      "acceptanceCriteria": [
        "Create src/notification/mod.rs with module exports",
        "Define Notification enum (RateLimited, UsageLimitExceeded, Timeout, Retrying, Paused, Resuming)",
        "Each variant includes relevant data (countdown, attempt, reason)",
        "Add pub mod notification; to src/lib.rs",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Notifications displayed via RalphDisplay"
    },
    {
      "id": "US-010",
      "title": "Notification renderer with themed panels",
      "description": "As a user, I want themed notification panels for different error states.",
      "acceptanceCriteria": [
        "Create src/notification/renderer.rs",
        "Define NotificationRenderer with reference to RalphDisplay",
        "Implement render_rate_limit() with countdown timer display",
        "Implement render_usage_limit() with action required message",
        "Implement render_timeout() with checkpoint confirmation",
        "Implement render_retry() with attempt number and delay",
        "Implement render_paused() with resume instructions",
        "Use existing color scheme from src/ui/colors.rs",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": "Reuses existing RalphDisplay and color utilities"
    },
    {
      "id": "US-011",
      "title": "Extend ExecutionState with Paused and WaitingForRetry",
      "description": "As Ralph, I need new execution states to represent pause and retry conditions.",
      "acceptanceCriteria": [
        "Add Paused variant to ExecutionState in src/mcp/server.rs",
        "Paused includes story_id, paused_at, pause_reason",
        "Add WaitingForRetry variant to ExecutionState",
        "WaitingForRetry includes story_id, retry_at, attempt, max_attempts",
        "Update GetStatusResponse to handle new states",
        "Update state_description() for new states",
        "Update display.update_from_state() for new states",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": "Minimal changes to existing state machine"
    },
    {
      "id": "US-012",
      "title": "Add --resume and --timeout CLI flags",
      "description": "As a user, I want CLI flags to control resume and timeout behavior.",
      "acceptanceCriteria": [
        "Add --resume flag to run command in main.rs",
        "Add --no-resume flag to skip checkpoint prompt",
        "Add --timeout <seconds> flag for agent timeout override",
        "Add --no-checkpoint flag to disable checkpointing",
        "Update run command help text",
        "Parse flags and pass to runner",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": "Follow existing CLI patterns in main.rs"
    },
    {
      "id": "US-013",
      "title": "Add ralph status command",
      "description": "As a user, I want a status command to check execution state without starting a run.",
      "acceptanceCriteria": [
        "Add 'status' subcommand to CLI in main.rs",
        "Display current/last execution state",
        "Display checkpoint info if present (story, iteration, pause reason, age)",
        "Display suggested action based on state",
        "Exit code 0 for idle, 1 for failed, 75 for paused",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": "Exit code 75 = EX_TEMPFAIL for temporary failure"
    },
    {
      "id": "US-014",
      "title": "Integrate checkpoint save into runner loop",
      "description": "As a user, I want checkpoints saved automatically during execution.",
      "acceptanceCriteria": [
        "Update runner.rs to accept CheckpointManager",
        "Save checkpoint before each iteration starts",
        "Save checkpoint after quality gates complete",
        "Save checkpoint on any pause or error condition",
        "Clear checkpoint on successful story completion",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": "Checkpoint saved at safe points only"
    },
    {
      "id": "US-015",
      "title": "Integrate checkpoint resume into runner startup",
      "description": "As a user, I want Ralph to prompt for resume when checkpoint exists.",
      "acceptanceCriteria": [
        "Check for checkpoint in .ralph/checkpoint.json on run command",
        "Display checkpoint summary (story, iteration, reason, age)",
        "Prompt user: Resume / Discard / View details",
        "If --resume flag, auto-resume without prompt",
        "If --no-resume flag, discard without prompt",
        "Resume sets execution to continue from checkpoint iteration",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": "Interactive prompt using dialoguer or similar"
    },
    {
      "id": "US-016",
      "title": "Integrate timeout wrapper into agent executor",
      "description": "As Ralph, I need agent execution wrapped with timeout.",
      "acceptanceCriteria": [
        "Update StoryExecutor in src/mcp/tools/executor.rs",
        "Accept TimeoutConfig in ExecutorConfig",
        "Wrap execute_agent() with tokio::time::timeout()",
        "On timeout, save checkpoint before returning error",
        "Classify timeout as ErrorCategory::Timeout",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": "Hard timeout prevents infinite hangs"
    },
    {
      "id": "US-017",
      "title": "Integrate heartbeat monitor into agent executor",
      "description": "As Ralph, I need heartbeat monitoring during agent execution.",
      "acceptanceCriteria": [
        "Start HeartbeatMonitor before agent execution",
        "Update heartbeat on agent output/activity",
        "On stall warning, log warning message",
        "On stall detection, trigger graceful timeout",
        "Stop monitor after execution completes",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": false,
      "notes": "Stall detection is softer than hard timeout"
    },
    {
      "id": "US-018",
      "title": "Integrate error classification into executor result handling",
      "description": "As Ralph, I need to classify executor errors and determine recovery action.",
      "acceptanceCriteria": [
        "After agent execution, classify any error using ErrorDetector",
        "For Transient errors, apply retry strategy",
        "For UsageLimit errors, save checkpoint and pause",
        "For Fatal errors, stop execution with clear message",
        "For Timeout errors, save checkpoint and report",
        "Display appropriate notification for each case",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": false,
      "notes": "Maps classification to recovery action"
    },
    {
      "id": "US-019",
      "title": "Add pause key handler to keyboard input",
      "description": "As a user, I want to press 'p' to pause execution.",
      "acceptanceCriteria": [
        "Add 'p' key handler in src/ui/keyboard.rs",
        "Call pause_controller.request_pause() on 'p' press",
        "Display 'Pausing after current iteration...' message",
        "Ignore 'p' if already paused or pause requested",
        "Update help display to show 'p' key option",
        "Typecheck passes"
      ],
      "priority": 19,
      "passes": false,
      "notes": "Pause happens at next safe point, not immediately"
    },
    {
      "id": "US-020",
      "title": "Integration tests for error recovery system",
      "description": "As a developer, I need integration tests to verify the recovery system works end-to-end.",
      "acceptanceCriteria": [
        "Create tests/error_recovery_tests.rs",
        "Test checkpoint save and load roundtrip",
        "Test error classification for known patterns",
        "Test retry backoff calculation",
        "Test pause controller state transitions",
        "Test timeout wrapper behavior",
        "All tests pass"
      ],
      "priority": 20,
      "passes": false,
      "notes": "Uses tests/ directory for integration tests"
    }
  ]
}
